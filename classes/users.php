<?class Users {var $login_error;var $login_result;var $register_result;var $red_result;var $delete_result;var $check_result;var $recheck_text;var $select_user_type;var $users_list;var $str_users;var $this_user;var $one_user;var $this_account;var $login_info;var $toolbar;function __construct(){	if(isset($_POST['login_submit']) AND isset($_POST['login']) AND isset($_POST['password']))	{		$this->login();	}		if ($_SESSION['auth'] = TRUE AND $_SESSION['user'] != "")	{		$this->login_info();				$this->create_toolbar($this->login_info['type']);		$this->access_to_pages($this->login_info['type']);	}	else	{		$this->access_to_pages(0);	}		if(isset($_POST[register_submit]))	{		$this->register_user();	}		if($_GET['page'] == "logout")	{		$this->logout();	}		elseif($_GET['page'] == "login" AND $_GET[type] == "check")	{		$this->check_ok();	}	elseif($_GET['page'] == "login" AND $_GET['type'] == "recheck")	{		if(isset($_POST[submit]) AND $_POST[mail] != "")		{			$this->recheck($_POST[mail]);		}		else		{			$this->recheck_text = "<h1>Проверка аккаунта</h1>			<form action='' method='post'>			<p>Введите e-mail своего аккаунта: <input type='text' name='mail'></p>			<p><input type='submit' name='submit' value='Отправить'></p>			</form>";		}	}	elseif($_GET[page] == "account" AND $_SESSION[user] != "")	{		if($_POST[submit] != "")		{			$this->red_user($_SESSION[user]);		}		$this->create_this_account($_SESSION[user]);		$this->this_user = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE id='$_SESSION[user]'"));	}	elseif($_GET[page] == "users_list")	{		$this->create_users_list();	}	elseif($_GET[page] == "user" AND $_GET[id] != "")	{		$this->create_user($_GET[id]);	}	elseif($_GET[page] == "red_user" AND $_GET[id] != "")	{		$this->create_select_user_type($_GET[id]);		if($_POST[submit] != "")		{			$this->red_user($_GET[id]);		}		$this->this_user = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE id='$_GET[id]'"));	}	elseif($_GET[page] == "del_user" AND $_GET[id] != "")	{		$this->delete_user($_GET[id]);	}}function login(){	if($_POST['login'] == "")	{		$this->login_result = "<script>alert('Вы не ввели свой логин');</script>";	}	elseif($_POST['password'] == "")	{		$this->login_result = "<script>alert('Вы не ввели свой пароль');</script>";	}	else	{@			$sql = mysql_query("SELECT * FROM users WHERE login='$_POST[login]' AND password='".md5($_POST[password])."'");			$check = mysql_num_rows($sql);@			$login = mysql_fetch_array($sql);			if($check != 1)			{				$this->login_result = "<p class='error_msg'>Вы ввели неправильный логин или пароль</p>";			}			elseif($login['status'] == 0 AND $login['check_code'] == "ok")			{				$this->login_result = "<p class='error_msg'>Даный аккаунт заблокирован. Вход невозможен</p>";			}			elseif($login['status'] == 0 AND $login['check_code'] != "ok")			{				$this->login_result = "<p class='error_msg'>Ваша електронная почта не подтвержена. Запросите <a href='/login/recheck.html'>отправку проверочного письма повторно</a></p>";			}			else			{				$_SESSION['user'] = $login['id'];				$_SESSION['login'] = $login['login'];				$_SESSION['mail'] = $login['mail'];				$_SESSION['auth'] = TRUE;				$_SESSION['user_type'] = $login['type'];				if($_POST['login_memory'] == "1")				{					setCookie("login", "$_POST[login]", time()+2592000, "/");					setCookie("password", "".md5($_POST[password])."", time()+2592000, "/");				}			}	}}function login_info(){	$this->login_info = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE id='$_SESSION[user]'"));}function logout(){		$_SESSION['auth'] = FALSE;		$_SESSION['user'] = "";		$_SESSION['user_type'] = "";		$_SESSION['login'] = "";		setCookie("login", "");		setCookie("password", "");	header('Location: '.$_SERVER[HTTP_REFERER]);}function create_toolbar($user_type){	if($user_type == "3")	{		$this->toolbar = "<div class='toolbar'><a href='/add_menu.html'>+ пункт меню</a> <a href='/menu_list.html'>Меню</a>		<a href='/add_category.html'>+ категорию</a> <a href='/category_list.html'>Категории</a>		<a href='/add_product.html'>+ товар</a>		<a href='/add_page.html'>+ страницу</a>		<a href='/pages_list.html'>Мои страницы</a>		<a href='/adm_orders.html'>Заказы</a>		<a href='/add_filter.html'>+ фильтр</a>		</div>		<div class='toolbar_reserve'></div>";	}	else	{		$this->toolbar = "";	}}function register_user(){	if(md5($_POST['duck']) != $_SESSION["secret_code"])	{		$this->register_result .= "<p class='error_msg'>Вы не правильно ввели защитный текст с картинки (капча)</p>";		$error = 1;	}	if($_POST['login'] == "")	{		$this->register_result .= "<p class='error_msg'>Вы не ввели свой логин</p>";		$error = 1;	}	if($_POST['password'] == "")	{		$this->register_result .= "<p class='error_msg'>Вы не ввели свой пароль</p>";		$error = 1;	}	if($_POST['repassword'] == "")	{		$this->register_result .= "<p class='error_msg'>Вы не ввели свой пароль повторно</p>";		$error = 1;	}	if($_POST['repassword'] != $_POST['password'])	{		$this->register_result .= "<p class='error_msg'>Пароль и повторный пароль не совпадают</p>";		$error = 1;	}	if($_POST['mail'] == "")	{		$this->register_result .= "<p class='error_msg'>Вы не ввели свою електронную почту</p>";		$error = 1;	}	$query = mysql_query("SELECT id FROM users WHERE login='$_POST[login]'");	$check = mysql_num_rows($query);	if($check > 0)	{		$this->register_result .= "<p class='error_msg'>Пользователь с таким логином уже зарегистрирован</p>";		$error = 1;	}	$check = mysql_num_rows(mysql_query("SELECT id FROM users WHERE mail='$_POST[mail]'"));	if($check > 0)	{		$this->register_result .= "<p class='error_msg'>Пользователь с таким e-mail уже зарегистрирован</p>";		$error = 1;	}	if(!preg_match("/^([a-z0-9_\.-]+)@([a-z0-9_\.-]+)\.([a-z\.]{2,6})$/", $_POST[mail]))	{		$this->register_result .= "<p class='error_msg'>e-mail указан некоректно</p>";		$error = 1;	}	$phone = "(".$_POST[phone1].")".$_POST[phone2]."-".$_POST[phone3]."-".$_POST[phone4];	if(preg_match("/([^0-9\(\)-]+)/", $phone))	{		$this->register_result .= "<p class='error_msg'>Телефон указан некоректно</p>";		$error = 1;	}	if(!preg_match("/([0-9]+)/", $phone))	{		$phone = "";	}	$check = mysql_num_rows(mysql_query("SELECT id FROM users WHERE phone='$phone'"));	if($check > 0)	{		$this->register_result .= "<p class='error_msg'>Пользователь с таким телефоном уже зарегистрирован</p>";		$error = 1;	}	if($error != 1)	{		$check_code = Functions::randomise("lLn", 20);		$password = md5($_POST[password]);		$date_register = Date_time::get_date("today");		$last_enter = Date_time::get_date("datetime");		$last_ip = Functions::$ip;		$register = mysql_query("INSERT into users SET login='$_POST[login]', password='$password', mail='$_POST[mail]', name='$_POST[name]', surname='$_POST[surname]', phone='$phone', distribution='$_POST[distribution]', date_register='$date_register', last_enter='$last_enter', last_ip='$last_ip', type='1', status='1'");		$last_add_user = mysql_insert_id();		if($register)		{			$register2 = mysql_query("UPDATE users SET check_code='".$check_code."' WHERE id='$last_add_user'");		}		if($register2)		{			$this->register_result = "<p class='good_msg'>Аккаунт зарегистрирован. Теперь Вы можете пользоваться всеми нашими услугами</p>";			/*			$this->register_result = "<p class='good_msg'>Аккаунт зарегистрирован. На вашу електронную почту отправлено письмо с ссылкой подтверждения. Перейдите по ней.</p>			<p class='good_msg'>Если письма нет в папке «Входящие» проверьте папку «Спам»</p>";						$md_mail = md5($_POST[mail]);			$message = "Добрый день.\n			Вы регистрировались в интернет-магазине «Prodano.net». Это письмо для подтверждения вашей електронной почты.\n			Чтобы сделать это перейдите по ссылке ниже:\n			http://proba.kinofon.com.ua/login/check.html?u=".$last_add_user."&c=".$check_code."&m=".$md_mail."\n			\n			Если єто письмо пришло Вам по ошибке и вы не регистрировались на нашем сайте проигнурируйте его.\n			\n			\n			С уважением, администрация интернет-магазина «Gipsa»";			mail($_POST[mail], "Подтвердите регистрацию", $message,			"From: noreply@gipsa.ru\n"			."X-Mailer: PHP/" . phpversion()."\r\n"."Content-Type: text/plain; charset=UTF-8 \r\n");			*/		}		else		{			$this->register_result = "<p class='error_msg'>Случилась неопределенная ошибка. Обратитесь к администратору</p>";		}	}}function check_ok(){	if($_GET[u] != "" AND $_GET[c] != "" AND $_GET[m] != "")	{		$user = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE id='$_GET[u]'"));		if($user[check_code] == "ok")		{			$this->check_result = "<p class='good_msg'>У этого аккаунта електронный адрес уже подтвержден.</p> 			<p class='good'>Нет необходимости делать это во второй раз.</p>";		}		elseif($user[check_code] == $_GET[c] AND $_GET[m] == md5($user[mail]))		{			mysql_query("UPDATE users SET check_code='ok', status='1' WHERE id='$_GET[u]'");			$this->check_result = "<p class='good_msg'>Отлично! Ваш аккаун подтвержден. Теперь вы можете <a class='fancybox' href='#login'>залогиниться</a> и пользоватся всеми услугами нашего сайта.</p>";		}		else		{			$this->check_result = "<p class='error_msg'>Данные не совпадают. Подтверждение електронной почты невозможно</p>			<p class='error_msg'>Запросите <a href='/login/recheck.html'>отправку проверочного письма повторно</a></p>";		}	}	else	{		$this->check_result = "<p class='error_msg'>Ссылка повреждена. Подтверждение електронной почты невозможно</p>		<p class='error_msg'>Запросите <a href='/login/recheck.html'>отправку проверочного письма повторно</a></p>";	}}function recheck($mail){	$array = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE mail='$mail'"));	if($array[id] != "")	{		/*		$this->recheck_text = "<p class='good_msg'>На вашу електронную почту отправлено письмо с ссылкой подтверждения. Перейдите по ней.</p>		<p class='good_msg'>Если письма нет в папке «Входящие» проверьте папку «Спам»</p>";				$md_mail = md5($mail);		$message = "Добрый день.\n		Вы регистрировались в интернет-магазине «Prodano.net». Это письмо для подтверждения вашей електронной почты.\n		Чтобы сделать это перейдите по ссылке ниже:\n		http://proba.kinofon.com.ua/login/check.html?u=".$array[id]."&c=".$array[check_code]."&m=".$md_mail."\n		\n		Если это письмо пришло Вам по ошибке и вы не регистрировались на нашем сайте проигнурируйте его.\n		\n		\n		С уважением, администрация интернет-магазина «Gipsa»";		mail($mail, "Подтвердите регистрацию", $message,		"From: noreply@gipsa.ru\n"		."X-Mailer: PHP/" . phpversion()."\r\n"."Content-Type: text/plain; charset=UTF-8 \r\n");		*/	}}function red_user($id){	if($_SESSION[access] == 3 OR $_SESSION['user'] = $id)	{		if($_POST['password'] != $_POST['repassword'])	{		$this->red_result .= "<p class='error_msg'>Пароль и повтор пароля не совпадают</p>";		$error = 1;	}	if($_POST['mail'] == "" AND $_SESSION['user'] != $id)	{		$this->red_result .= "<p class='error_msg'>Вы не ввели електронную почту</p>";		$error = 1;	}	$check = mysql_num_rows(mysql_query("SELECT id FROM users WHERE mail='$_POST[mail]' AND id!='$id'"));	if($check > 0)	{		$this->red_result .= "<p class='error_msg'>Пользователь с таким e-mail уже зарегистрирован</p>";		$error = 1;	}	if(!preg_match("/^([a-z0-9_\.-]+)@([a-z0-9_\.-]+)\.([a-z\.]{2,6})$/", $_POST[mail]) AND $_SESSION['user'] != $id)	{		$this->red_result .= "<p class='error_msg'>e-mail указан некоректно</p>";		$error = 1;	}	if(preg_match("/([^0-9\(\)-]+)/", $_POST[phone]))	{		$this->red_result .= "<p class='error_msg'>Телефон указан некоректно</p>";		$error = 1;	}	if(!preg_match("/([0-9]+)/", $_POST[phone]))	{		$_POST[phone] = "";	}	$check = mysql_num_rows(mysql_query("SELECT id FROM users WHERE phone='$_POST[phone]' AND id!='$id'"));	if($check > 0)	{		$this->red_result .= "<p class='error_msg'>Пользователь с таким телефоном уже зарегистрирован</p>";		$error = 1;	}	if($error != 1)	{		$check = mysql_num_rows(mysql_query("SELECT * FROM users WHERE id='$id'"));		if($_POST[password] == "")		{			$password = $check[password];		}		else		{			$password = md5($_POST[password]);		}		if($_SESSION['user'] == $id AND $_SESSION[access] != 3)		{			$register = mysql_query("UPDATE users SET password='$password', name='$_POST[name]', surname='$_POST[surname]', phone='$_POST[phone]', distribution='$_POST[distribution]', date_register='$_POST[date_register]', type='$_POST[type]' WHERE id='$id'");		}		else		{			$register = mysql_query("UPDATE users SET password='$password', mail='$_POST[mail]', name='$_POST[name]', surname='$_POST[surname]', phone='$_POST[phone]', distribution='$_POST[distribution]', date_register='$_POST[date_register]', type='$_POST[type]' WHERE id='$id'");		}		$last_add_user = mysql_insert_id();		if($register)		{			$this->red_result = "<p class='good_msg'>Пользователь отредактирован</p>";		}		else		{			$this->red_result = "<p class='error_msg'>Случилась неопределенная ошибка. Пользователь не отредактирован</p>";		}	}		}}function delete_user($id){	if($_SESSION[access] == 3)	{		$id = eregi_replace("/[^0-9]/", "", $id);	$query = mysql_query("DELETE FROM users WHERE id='$id'");	if($query)	{		$this->delete_result = "<p class='good_msg'>Пользователь удалена</p>";	}	else	{		$this->delete_result = "<p class='error_msg'>Пользователя удалить не удалось</p>";	}		}	header("location:".$_SERVER[HTTP_REFERER]); }function access_to_pages($user_type){	if(($_GET[page] == "add_menu" OR $_GET[page] == "menu_list"	OR $_GET[page] == "add_category" OR $_GET[page] == "category_list" OR $_GET[page] == "red_category" OR $_GET[page] == "del_category"	OR $_GET[page] == "add_product" OR $_GET[page] == "red_product" OR $_GET[page] == "del_product"	OR $_GET[page] == "add_page" OR $_GET[page] == "red_page" OR $_GET[page] == "del_page"	OR $_GET[page] == "adm_orders"	OR $_GET[page] == "pages_list") AND $user_type != "3")	{		Pages::get_error("403");	}}function create_users_list(){	$str = $_GET[str];	if($_SESSION['access'] == 3)	{				$stipulation = "";		$query = mysql_query("SELECT id FROM users WHERE ( 1=1 )".$stipulation);		$num_rows_str = mysql_num_rows($query);			if($num_rows_str > 0)		{		//Сторінки		$total = ceil($num_rows_str / 50);		if(empty($str) or $str < 0) { $str = 1; }		if($str > $total) { $str = $total; }		$str_start = $str * 50 - 50;				$storinka = "users";		if($total > 1)		{				if($total < 3 )		{			$pervstr = ""; $nextstr = "";		}		else		{			// Проверяем нужны ли стрелки назад 			if ($str > 4) $pervstr = "<a href='".$storinka."/1.html'>1</a> ...";			// Проверяем нужны ли стрелки вперед 			if ( $str >= $total - 5) $nextstr = "";			elseif ($str != $total) $nextstr = "... <a href='".$storinka."/".$total.".html'>".$total."</a>"; 		}		// Находим дві ближайшие станицы с обоих краев, если они есть		if($str - 6 > 0) $str6left = '<a href='.$storinka.'/'. ($str - 6) .'.html>'. ($str - 6) .'</a>'; 		if($str - 5 > 0) $str5left = '<a href='.$storinka.'/'. ($str - 5) .'.html>'. ($str - 5) .'</a>'; 		if($str - 4 > 0) $str4left = '<a href='.$storinka.'/'. ($str - 4) .'.html>'. ($str - 4) .'</a>'; 		if($str - 3 > 0) $str3left = '<a href='.$storinka.'/'. ($str - 3) .'.html>'. ($str - 3) .'</a>'; 		if($str - 2 > 0) $str2left = '<a href='.$storinka.'/'. ($str - 2) .'.html>'. ($str - 2) .'</a>'; 		if($str - 1 > 0) $str1left = '<a href='.$storinka.'/'. ($str - 1) .'.html>'. ($str - 1) .'</a>'; 		if($str + 1 <= $total) $str1right = '<a href='.$storinka.'/'. ($str + 1) .'.html>'. ($str + 1) .'</a>';		if($str + 2 <= $total) $str2right = '<a href='.$storinka.'/'. ($str + 2) .'.html>'. ($str + 2) .'</a>';		if($str + 3 <= $total) $str3right = '<a href='.$storinka.'/'. ($str + 3) .'.html>'. ($str + 3) .'</a>';		if($str + 4 <= $total) $str4right = '<a href='.$storinka.'/'. ($str + 4) .'.html>'. ($str + 4) .'</a>';		if($str + 5 <= $total) $str5right = '<a href='.$storinka.'/'. ($str + 5) .'.html>'. ($str + 5) .'</a>';		if($str + 6 <= $total) $str6right = '<a href='.$storinka.'/'. ($str + 6) .'.html>'. ($str + 6) .'</a>';				$this->str_users = "<div class='pages'> $pervstr";		if($str == $total) $this->str_users .= "$str6left $str5left $str4left";		if($str == $total-1) $this->str_users .= "$str5left $str4left";		if($str == $total-2) $this->str_users .= "$str4left";		$this->str_users .= " ".$str3left." ".$str2left." ".$str1left." <span>".$str."</span> ".$str1right." ".$str2right." ".$str3right." ";		if($str == 1) $this->str_users .= " $str4right $str5right $str6right";		if($str == 2) $this->str_users .= " $str4right $str5right";		if($str == 3) $this->str_users .= " $str4right";		$this->str_users .= " ".$nextstr."</div>";				}		$query = mysql_query("SELECT * FROM users WHERE (1=1)".$stipulation." ORDER by id desc LIMIT $str_start, 50");		$this->users_list .= "		<ul class='material_list'>";		while($array = mysql_fetch_array($query))		{			$this->users_list .= "			<li><a href='user/$array[id].html'>$array[login]</a>			<div class='tools'>			<a href='red_user/$array[id].html' class='config' title='Редактировать'></a>			<a href='del_user/$array[id].html' class='remove' matherial_id='$array[id]' title='Удалить'></a>			</div>			</li>";		}		$this->users_list .= "</ul>";		}	}}function create_user($id){	if($_SESSION[access] == 3)	{		$array = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE id='$id'"));	if($array[id] != "")	{		$this->this_user = $array;		$this->one_user = "		<div style='width:100%; overflow:hidden; margin-bottom:10px;'>				<div class='yellow_block block' style='float:left; width:48%;'>		<div class='title'>Детали <div class='tools'><a href='red_user/".$id.".html'><span class='fa fa-pencil-square-o'></span></a></div></div>		<div class='content'>			<div><p class='left'>Пользователь:</p> <p class='right'>".$array[id]."</p></div>			<div><p class='left'>Почта:</p> <p class='right'>".$array[mail]."</p></div>			<div><p class='left'>Статус:</p> <p class='right'>";			if($array[type] == 1)			{				$this->one_user .= "Пользователь";			}			elseif($array[type] == 2)			{				$this->one_user .= "Модератор";			}			elseif($array[type] == 3)			{				$this->one_user .= "Администратор";			}					$this->one_user .= "</p></div>		<div><p class='left'>Имя:</p> <p class='right'>".$array[name]."</p></div>		<div><p class='left'>Фамилия:</p> <p class='right'>".$array[surname]."</p></div>		<div><p class='left'>Телефон:</p> <p class='right'>".$array[phone]."</p></div>		</div>		</div>				<div class='hard_green_block block' style='float:right; width:48%;'>		<div class='title'>Информация</div>		<div class='content'>			<div><p class='left'>Дата регистрации:</p> <p class='right'>".$array[date_register]."</p></div>			<div><p class='left'>Последний вход:</p> <p class='right'>$array[last_enter]</p></div>			<div><p class='left'>Последний ip:</p> <p class='right'>$array[last_ip]</p></div>		</div>		</div>				</div>";	}		}}function create_select_user_type($id){	$user = mysql_fetch_array(mysql_query("SELECT type FROM users WHERE id='$id'"));	if($user[type] != "")	{				$this->select_user_type = "<option value='1'";		if($user[type] == 1) { $this->select_user_type .= " selected"; }		$this->select_user_type .= ">Пользователь</option>		<option value='2'";		if($user[type] == 2) { $this->select_user_type .= " selected"; }		$this->select_user_type .= ">Модератор</option>		<option value='3'";		if($user[type] == 3) { $this->select_user_type .= " selected"; }		$this->select_user_type .= ">Администратор</option>";	}}function create_this_account($id){	$user = mysql_fetch_array(mysql_query("SELECT * FROM users WHERE id='$id'"));	if($user[id] != "")	{		if($_GET[type] == "edit")		{				}		elseif($_GET[type] == "orders")		{				}		else		{			$this->this_account = "<h1>Мои настройки</h1>			<p><b>Ваше имя:</b> ".$user[name]." ".$user[surname]."</p>			<p><b>Электронная почтa:</b> ".$user[mail]."</p>			<p><b>Телефон:</b> ".$user[phone]."</p>			<p><b>Дата регистрации:</b> ".$user[date_register]."</p>			<p><a href='account/edit.html'>Редактировать личные данные</a></p>			";		}	}	else	{		$this->this_account = "<h2>У вас не создан аккаунт. Доступ к странице запрещен</h2>";	}}}